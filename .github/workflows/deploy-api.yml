name: deploy-api

on:
  push:
    branches: [ "main" ]
    paths:
      - "backend/**"
      - "openapi.yaml"
      - ".github/workflows/deploy-api.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install backend deps
        working-directory: backend
        run: npm ci

      - name: Build function.zip
        run: |
          rm -rf dist-fn function.zip
          mkdir -p dist-fn
          cp backend/function/index.js backend/function/app.mjs backend/function/package.json dist-fn/
          cp -r backend/node_modules dist-fn/node_modules
          (cd dist-fn && zip -r ../function.zip .)

      - name: Install yc CLI
        uses: nightstory/setup-yc@v1
        with:
          enable-cache: true

      - name: yc auth as service account
        env:
          YC_SA_KEY_JSON: ${{ secrets.YC_SA_KEY_JSON }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
        run: |
          echo "$YC_SA_KEY_JSON" > sa-key.json
          yc config profile create gha || true
          yc config profile activate gha
          yc config set service-account-key sa-key.json
          yc config set folder-id "$YC_FOLDER_ID"

      - name: Deploy Cloud Function (new version)
        env:
          YC_FUNCTION_ID: ${{ secrets.YC_FUNCTION_ID }}
          YC_FUNCTION_SA_ID: ${{ secrets.YC_FUNCTION_SA_ID }}

          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          YDB_DB_NAME: ${{ secrets.YDB_DB_NAME }}
          YDB_TABLE_PREFIX: ${{ secrets.YDB_TABLE_PREFIX }}

          LOGS_BUCKET: ${{ secrets.RAW_BUCKET }}
          LOGS_PREFIX: ${{ secrets.LOGS_PREFIX }}

          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}

          CNS_ENDPOINT: ${{ secrets.CNS_ENDPOINT }}
          SMS_MODE: ${{ secrets.SMS_MODE }}
          DEBUG_OTP: ${{ secrets.DEBUG_OTP }}
        run: |
          yc serverless function version create \
            --function-id "$YC_FUNCTION_ID" \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 512MB \
            --execution-timeout 10s \
            --service-account-id "$YC_FUNCTION_SA_ID" \
            --environment JWT_SECRET="$JWT_SECRET",YDB_DB_NAME="$YDB_DB_NAME",YDB_TABLE_PREFIX="$YDB_TABLE_PREFIX",LOGS_BUCKET="$LOGS_BUCKET",LOGS_PREFIX="$LOGS_PREFIX",AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID",AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY",AWS_REGION="$AWS_REGION",S3_ENDPOINT="$S3_ENDPOINT",CNS_ENDPOINT="$CNS_ENDPOINT",SMS_MODE="$SMS_MODE",DEBUG_OTP="$DEBUG_OTP" \
            --source-path function.zip

      - name: Render OpenAPI + update API Gateway
        env:
          YC_API_GW_ID: ${{ secrets.YC_API_GW_ID }}
          FRONT_BUCKET: ${{ secrets.STATIC_BUCKET }}
          SERVICE_ACCOUNT_ID: ${{ secrets.YC_GATEWAY_SA_ID }}
          API_FUNCTION_ID: ${{ secrets.YC_FUNCTION_ID }}
        run: |
          python - <<'PY'
          import os, pathlib
          p = pathlib.Path("openapi.yaml")
          text = p.read_text(encoding="utf-8")
          for k in ["FRONT_BUCKET","SERVICE_ACCOUNT_ID","API_FUNCTION_ID"]:
            text = text.replace("${%s}" % k, os.environ[k])
          pathlib.Path("openapi.rendered.yaml").write_text(text, encoding="utf-8")
          PY

          yc serverless api-gateway update --id "$YC_API_GW_ID" --spec=openapi.rendered.yaml